<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css"
          href="http://server-sp-it/sites/wiki/Style%20Library/Printers/jquery-ui.min.css"/>
    <style>
        fieldset {
            border: 0;
        }

        label {
            display: block;
            margin: 30px 0 0 0;
        }

        textarea {
            width: 97%;
            margin-top: 4px;
        }

        select {
            width: 200px;
        }

        .inner {
            display: inline-block;
        }
    </style>
    <script>

        var listId = "629c7c86-dd24-4337-b01a-48a6da811cc5";
        var siteUrl = "http://server-sp-it/sites/wiki";
        var catridgeFieldName = "_x041a__x0430__x0440__x0442__x04";
        var catridgeCountFieldName = "_x041a__x043e__x043b__x0438__x04";
        var actionFieldName = "Action";

        $(document).ready(function () {
            $("#dialog2").dialog({
                resizable: false,
                modal: true,
                buttons: [{text: "Добавить", click: addDataToTable}],
                autoOpen: false
            });

            $("#dialogstatistics").dialog({
                resizable: false,
                modal: true,
                autoOpen: false
            });

            $("#opener2").click(function () {
                if ($('#mySelect').has('option').length <= 0) {
                    addItemsDataToDialog();
                }
                $("#dialog2").dialog("open");
            });

            $("#openstatistics").click(function () {

                $("#dialogstatistics").dialog("open");
            });

            $("#dialogform").validate({
                rules: {
                    pswd: {
                        required: true,
                        digits: true
                    }
                },
                messages: {
                    pswd: {
                        required: "Поле 'Количество' обязательно для заполнения",
                        digits: "Должны быть цифры"
                    }
                }
            });

            function addDataToTable() {
                if (!$('#dialogform').valid()) return;
                var selectedValue = $("#mySelect option:selected").text();
                var clientContext = new SP.ClientContext(siteUrl);
                var list = clientContext.get_web().get_lists().getById(listId);

                var caml = queryByUniqueTitle(catridgeFieldName, selectedValue);
                var collListItems = list.getItems(caml);

                clientContext.load(collListItems);

                clientContext.executeQueryAsync(function () {
                            var enumerator = collListItems.getEnumerator();
                            while (enumerator.moveNext()) {
                                var item = enumerator.get_current();
                                item.set_item(catridgeCountFieldName, (item.get_item(catridgeCountFieldName) + parseInt($("#countinput").val())));
                                item.set_item(actionFieldName, "Привезено " + parseInt($("#countinput").val()) + " картриджей");
                                item.update();
                            }
                            clientContext.executeQueryAsync(function () {
                                        console.log("success get count");
                                    },
                                    onQueryFailed);
                            document.location.reload();
                        },
                        onQueryFailed);

                $("#dialog2").dialog("close");
            }

            function addItemsDataToDialog() {
                $.ajax({
                    url: "http://server-sp-it/sites/wiki/" + "/_api/web/lists(guid'" + listId + "')/items",
                    method: "GET",
                    headers: {"Accept": "application/json; odata=verbose"},
                    success: function (data) {
                        var items = data.d.results;
                        var cartridgesData = [];
                        var cartridgeInternalField = "OData__x041a__x0430__x0440__x0442__x04";
                        for (var i = 0; i < items.length; i++) {
                            if ($.inArray(items[i][cartridgeInternalField], cartridgesData) === -1 && items[i][cartridgeInternalField] != null) {
                                cartridgesData.push(items[i][cartridgeInternalField]);
                            }
                        }
                        $.each(cartridgesData, function (key, value) {
                            $('#mySelect')
                                    .append($("<option></option>")
                                            .attr("value", key)
                                            .text(value));
                        });
                    }, error: onQueryFailed
                });
            }
        });
    </script>
</head>
<body>

<div id="dialog2" title="Введите данные" class="ui-widget">
    <form id="mainform" name="mainform">

    </form>
    <form id="dialogform">
        <div><label>Картриж:</label></div>
        <div><select id="mySelect"></select></div>
        <div><label> Количество:</label><input id="countinput" name="pswd"/></div>
    </form>
</div>

<div id="dialogstatistics" title="Общая статистика картриджей">
    <div id="contentstatistics"></div>
</div>

<div>
    <input class="inner " type="button" value="Добавить " id="opener2">
    <input class="inner " type="button" value="Общая статистика по картриджам" id="openstatistics">
</div>
</body>