<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css"
          href="http://server-sp-it/sites/wiki/Style%20Library/Printers/jquery-ui.min.css"/>
    <link rel="stylesheet" type="text/css"
          href="http://server-sp-it/sites/wiki/Style%20Library/corelibs/jquery.appendGrid-1.6.1.css"/>

    <script type="text/javascript"
            src="http://server-sp-it/sites/wiki/Style%20Library/corelibs/jquery-1.7.2.min.js"></script>
    <script type="text/javascript"
            src="http://server-sp-it/sites/wiki/Style%20Library/corelibs/jquery-ui.min.js"></script>
    <script type="text/javascript"
            src="http://server-sp-it/sites/wiki/Style%20Library/corelibs/jquery.validate.min.js"></script>
    <script type="text/javascript"
            src="http://server-sp-it/sites/wiki/Style%20Library/corelibs/jquery.SPServices-0.7.1a.min.js"></script>
    <script type="text/javascript"
            src="http://server-sp-it/sites/wiki/Style%20Library/corelibs/jquery.SPWidgets.min.js"></script>
    <script type="text/javascript"
            src="http://server-sp-it/sites/wiki/Style%20Library/corelibs/getCurrentUser.js"></script>
    <script type="text/javascript"
            src="http://server-sp-it/sites/wiki/Style%20Library/corelibs/IsCurrentUserMemberOfGroup.js"></script>
    <script type="text/javascript" src="http://server-sp-it/sites/wiki/Style%20Library/corelibs/camljs.js"></script>
    <script type="text/javascript" src="http://server-sp-it/sites/wiki/Style%20Library/corelibs/moment.min.js"></script>
    <script type="text/javascript"
            src="http://server-sp-it/sites/wiki/Style%20Library/corelibs/moment-with-locales.min.js"></script>
    <script type="text/javascript" src="http://server-sp-it/sites/wiki/Style%20Library/corelibs/query.js"></script>
    <script type="text/javascript" src="http://server-sp-it/sites/wiki/Style%20Library/corelibs/utils.js"></script>

    <script type="text/javascript"
            src="http://server-sp-it/sites/wiki/Style%20Library/corelibs/jquery.appendGrid-1.6.1.js"></script>
    <script type="text/javascript"
            src="http://server-sp-it/sites/wiki/Style%20Library/Printers/printersCore.js"></script>
    <style>
        fieldset {
            border: 0;
        }

        label {
            display: block;
            margin: 30px 0 0 0;
        }

        textarea {
            width: 97%;
            margin-top: 4px;
        }

        select {
            width: 200px;
        }

        .inner {
            display: inline-block;
        }

        .inner [hidden] {
            display: inline-block;
        }

    </style>
    <script>

        var listId = "629c7c86-dd24-4337-b01a-48a6da811cc5";
        var siteUrl = "http://server-sp-it/sites/wiki";
        var catridgeFieldName = "_x041a__x0430__x0440__x0442__x04";
        var catridgeCountFieldName = "_x041a__x043e__x043b__x0438__x04";
        var actionFieldName = "Action";
        var editingGroupId = 41;
        var listType;

        $(document).ready(function () {

            function IsCurrentUserWithContributePerms() {
                IsCurrentUserMemberOfGroup(editingGroupId, function (isCurrentUserInGroup) {
                    if (isCurrentUserInGroup) {
                        console.log("isCurrentUserInGroup");
                        $("#opener2").show();
                    }
                });
            }

            ExecuteOrDelayUntilScriptLoaded(IsCurrentUserWithContributePerms, 'SP.js');


            $("#dialog2").dialog({
                resizable: false,
                modal: true,
                buttons: [{text: "Добавить", click: addDataToTable}],
                autoOpen: false
            });

            $("#dialogstatistics").dialog({
                resizable: false,
                modal: true,
                autoOpen: false
            });

            $("#opener2").click(function () {
                //$("#dialog2").show();
                if ($('#mySelect').has('option').length <= 0) {
                    addItemsDataToDialog();
                }
                $("#dialog2").dialog("open");
            });

            $("#openstatistics").click(function () {
                //$("#dialogstatistics").show();
                $("#dialogstatistics").dialog("open");
            });

            $("#dialogform").validate({
                rules: {
                    pswd: {
                        required: true,
                        digits: true
                    }
                },
                messages: {
                    pswd: {
                        required: "Поле 'Количество' обязательно для заполнения",
                        digits: "Должны быть цифры"
                    }
                }
            });


            function addDataToTable() {
                if (!$('#dialogform').valid()) return;
                var selectedValue = $("#mySelect option:selected").text();
                var clientContext = new SP.ClientContext(siteUrl);
                var list = clientContext.get_web().get_lists().getById(listId);

                var caml = queryByUniqueTitle(catridgeFieldName, selectedValue);
                var collListItems = list.getItems(caml);

                clientContext.load(collListItems);

                clientContext.executeQueryAsync(function () {
                            var enumerator = collListItems.getEnumerator();
                            while (enumerator.moveNext()) {
                                var item = enumerator.get_current();
                                item.set_item(catridgeCountFieldName, (item.get_item(catridgeCountFieldName) + parseInt($("#countinput").val())));
                                item.set_item(actionFieldName, "Привезено " + parseInt($("#countinput").val()) + " картриджей");
                                item.update();
                            }
                            clientContext.executeQueryAsync(function () {
                                        console.log("success get count");
                                    },
                                    onQueryFailed);
                            document.location.reload();
                        },
                        onQueryFailed);

                $("#dialog2").dialog("close");
            }

            function addItemsDataToDialog() {
                $.ajax({
                    url: "http://server-sp-it/sites/wiki/" + "/_api/web/lists(guid'" + listId + "')/items",
                    method: "GET",
                    headers: {"Accept": "application/json; odata=verbose"},
                    success: function (data) {
                        var items = data.d.results;
                        var cartridgesData = [];
                        var cartridgeInternalField = "OData__x041a__x0430__x0440__x0442__x04";
                        for (var i = 0; i < items.length; i++) {
                            if ($.inArray(items[i][cartridgeInternalField], cartridgesData) === -1 && items[i][cartridgeInternalField] != null) {
                                cartridgesData.push(items[i][cartridgeInternalField]);
                            }
                        }
                        $.each(cartridgesData, function (key, value) {
                            $('#mySelect')
                                    .append($("<option></option>")
                                            .attr("value", key)
                                            .text(value));
                        });
                    }, error: onQueryFailed
                });
            }

            $("#dialogaddprinter").dialog({
                resizable: false,
                modal: true,
                width: 600,
                buttons: [{text: "Добавить", click: addPrinterToList}],
                autoOpen: false
            });

            $("#opendialogaddprinter").click(function () {

                $('#tblPrinterAppendGrid').appendGrid({
                    caption: 'Данные принтера',
                    initRows: 1,
                    columns: [
                        {
                            name: 'Filial', display: 'Филиал', type: 'text', ctrlCss: {width: '160px'}

                        },
                        {name: 'Name', display: 'Имя', type: 'text', ctrlCss: {width: '160px'}},
                        {name: 'Ip', display: 'Ip', type: 'text', ctrlCss: {width: '140px'}},
                        {name: 'Room', display: 'Комната', type: 'text'}
                    ],
                    hideButtons: {
                        remove: true,
                        removeLast: true,
                        append: true,
                        insert: true,
                        moveUp: true,
                        moveDown: true
                    }
                });

                $('#tblCartridgeAppendGrid').appendGrid({
                    caption: 'Названия картриджей',
                    initRows: 4,
                    columns: [
                        {
                            name: 'Color',
                            display: 'Цвет',
                            type: 'text',
                            ctrlAttr: {maxlength: 100, readonly: "readonly"},
                            ctrlCss: {width: '100px'}

                        },
                        {name: 'Name', display: 'Имя', type: 'text', ctrlCss: {width: '160px'}},
                        {
                            name: 'NameFromExist',
                            display: 'Имя из существующих',
                            type: 'select',
                            ctrlOptions: {0: '{Выбрать}', 1: ''}
                        }
                    ],
                    hideButtons: {
                        remove: true,
                        removeLast: true,
                        append: true,
                        insert: true,
                        moveUp: true,
                        moveDown: true
                    }
                });
                $('#tblCartridgeAppendGrid').appendGrid('setCtrlValue', 'Color', 0, 'Синий');
                $('#tblCartridgeAppendGrid').appendGrid('setCtrlValue', 'Color', 1, 'Красный');
                $('#tblCartridgeAppendGrid').appendGrid('setCtrlValue', 'Color', 2, 'Желтый');
                $('#tblCartridgeAppendGrid').appendGrid('setCtrlValue', 'Color', 3, 'Черный');
                $("#dialogaddprinter").dialog("open");
            });

            function addPrinterToList() {
                var namePrinter = $('#tblPrinterAppendGrid').appendGrid('getCtrlValue', 'Name', 1);
                var filial = $('#tblPrinterAppendGrid').appendGrid('getCtrlValue', 'Filial', 1);
                var iP = $('#tblPrinterAppendGrid').appendGrid('getCtrlValue', 'Ip', 1);
                var room = $('#tblPrinterAppendGrid').appendGrid('getCtrlValue', 'Room', 1);


                var nameBluerCart = $('#tblCartridgeAppendGrid').appendGrid('getCtrlValue', 'Name', 0);
                var nameRedCart = $('#tblCartridgeAppendGrid').appendGrid('getCtrlValue', 'Name', 1);
                var nameYellowCart = $('#tblCartridgeAppendGrid').appendGrid('getCtrlValue', 'Name', 2);
                var nameBlackCart = $('#tblCartridgeAppendGrid').appendGrid('getCtrlValue', 'Name', 3);

                var colors = ["Blue", "magenta", "Yellow", "Black"];

                /*for (i = 0; i = <3;i++)
                 {
                 }*/
                var countCartriges = 4;
                addColorPrinters(listId, itemData);
            }

            function getItemData(namePrinter, isColor, color, choiceCartridge, choiceFilial) {
                var itemData = {
                    "__metadata": {
                        "type": "SP.Data.List3ListItem",
                        "Title": "",
                        "IsColor": "",
                        "Color": "",
                        "OData__x041a__x0430__x0440__x0442__x04": "",
                        "OData__x0424__x0438__x043b__x0438__x04": ""
                    },
                    "Title": namePrinter,
                    "IsColor": isColor,
                    "Color": color,
                    "OData__x041a__x0430__x0440__x0442__x04": choiceCartridge,
                    "OData__x0424__x0438__x043b__x0438__x04": choiceFilial
                };
                return itemData;
            }

            function addColorPrinters(listId, itemData, indexCartridge, countCartridges) {
                $.ajax({
                    url: _spPageContextInfo.siteAbsoluteUrl + "/_api/web/lists(guid'" + listId + "')/items",
                    type: "POST",
                    contentType: "application/json;odata=verbose",
                    data: JSON.stringify(itemData),
                    headers: {
                        "Accept": "application/json;odata=verbose",
                        "X-RequestDigest": $("#__REQUESTDIGEST").val()
                    },
                    success: function (sender, args) {
                        console.log("success");
                        indexCartridge = indexCartridge - 1;
                        console.log("success" + indexCartridge + " indexCartrige");
                        if (indexCartridge < countCartridges) {
                            //addColorPrinters(listId,)
                        } else {
                            location.reload();
                        }
                    },
                    error: onError
                });
            }

            // Display error messages.
            function onError(error) {
                console.log(error.responseText);
            }
        });
    </script>
</head>
<body>

<div id="dialog2" title="Введите данные" class="ui-widget" hidden="true">
    <form id="mainform" name="mainform">

    </form>
    <form id="dialogform">
        <div><label>Картриж:</label></div>
        <div><select id="mySelect"></select></div>
        <div><label> Количество:</label><input id="countinput" name="pswd"/></div>
    </form>
</div>

<div id="dialogaddprinter" title="Добавление принтера">
    <div id="contentaddprinter">
        <br>
        <table id="tblPrinterAppendGrid">
        </table>

        <br>
        <br>
        <table id="tblCartridgeAppendGrid">
        </table>

    </div>
</div>

<div id="dialogstatistics" title="Общая статистика картриджей">
    <div id="contentstatistics"></div>
</div>

<div>
    <input class="innerbutton" type="button" value="Добавить " id="opener2" hidden="true">
    <input class="inner " type="button" value="Общая статистика по картриджам" id="openstatistics">
    <input class="inner" type="button" value="Добавить принтер" id="opendialogaddprinter">
</div>
</body>